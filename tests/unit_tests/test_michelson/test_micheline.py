from unittest import TestCase

from parameterized import parameterized  # type: ignore

from pytezos.michelson.forge import forge_micheline
from pytezos.michelson.forge import forge_script_expr
from pytezos.michelson.forge import unforge_micheline
from pytezos.michelson.micheline import blind_unpack
from pytezos.michelson.types.base import MichelsonType
from pytezos.operation.forge import forge_operation_group

unknown_data = [
    '0501000000056f776e6572',
    '050a000000160000e8b36c80efb51ec85a14562426049aa182a3ce38',
    '050100000006706175736564',
    '050303',
    '05010000000866616c6c6261636b',
    '0502000000270316031607430368010000001655706172616d4e6f53756368456e747279506f696e7403420327',
    '0501000000086e65774f776e6572',
    '050306',
    '0501000000096f70657261746f7273',
    '050200000000',
    '050100000009746f6b656e436f6465',
    '050100000005545a425443',
    '050100000009746f6b656e4e616d65',
    '050100000005545a425443',
    '05010000000b746f74616c4275726e6564',
    '050000',
    '05010000000b746f74616c4d696e746564',
    '050000',
    '05010000000b746f74616c537570706c79',
    '050000',
    '05010000000d72656465656d41646472657373',
    '050a000000160000e8b36c80efb51ec85a14562426049aa182a3ce38',
    '0507070100000004636f6465010000000863616c6c4275726e',
    '05020000054903210316051f02000000020317050d0362072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f02000000020317051f02000000c20321074303690a0000000f0501000000096f70657261746f72730329072f020000002507430368010000001a5553746f72653a206e6f206669656c64206f70657261746f727303270200000000050d0566036e072f020000002d0743036801000000225553746f72653a206661696c656420746f20756e7061636b206f70657261746f72730327020000000003480339072c02000000000200000026074307650368036c0707010000001353656e64657249734e6f744f70657261746f72030b0327051f02000000960321074303690a0000001305010000000d72656465656d416464726573730329072f020000002907430368010000001e5553746f72653a206e6f206669656c642072656465656d4164647265737303270200000000050d036e072f02000000310743036801000000265553746f72653a206661696c656420746f20756e7061636b2072656465656d4164647265737303270200000000034203210316051f020000000203170321051f02000002a8034c0342051f02000000020321034c051f02000000020321034c03160743036801000000066c65646765720342030c0329072f020000000c053e076503620760036e03620200000044050d076503620760036e0362072f020000002a07430368010000001f5553746f72653a206661696c656420746f20756e7061636b206c6564676572032702000000000346072f02000000290317074303620000034c03420743036801000000104e6f74456e6f75676842616c616e636503420327020000000003210316071f000202000000020321057000020317034c034b0356072f020000002e0316051f02000000020321034c031703420743036801000000104e6f74456e6f75676842616c616e6365034203270200000000051f020000000d0321051f020000000203170316034c03200342051f02000000020321034c051f02000000700321031603300325072c020000002603210317034503300325072c020000000e0320053e076503620760036e03620200000002034602000000020346034c03160743036801000000066c65646765720342030c051f0200000014072f0200000004053e03690200000004030c034603500317033b051f02000000900321074303690a0000001105010000000b746f74616c537570706c790329072f020000002707430368010000001c5553746f72653a206e6f206669656c6420746f74616c537570706c7903270200000000050d0362072f020000002f0743036801000000245553746f72653a206661696c656420746f20756e7061636b20746f74616c537570706c790327020000000003120356072f020000002a07430368010000001f496e7465726e616c3a204e6567617469766520746f74616c20737570706c7903270200000000030c0346074303690a0000001105010000000b746f74616c537570706c790350051f02000000900321074303690a0000001105010000000b746f74616c4275726e65640329072f020000002707430368010000001c5553746f72653a206e6f206669656c6420746f74616c4275726e656403270200000000050d0362072f020000002f0743036801000000245553746f72653a206661696c656420746f20756e7061636b20746f74616c4275726e6564032702000000000312030c0346074303690a0000001105010000000b746f74616c4275726e65640350053d036d034203210316051f020000000203170342',
    '0507070100000004636f6465010000000863616c6c4d696e74',
    '05020000042d03210316051f02000000020317050d0765036e0362072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f02000000020317051f02000000c20321074303690a0000000f0501000000096f70657261746f72730329072f020000002507430368010000001a5553746f72653a206e6f206669656c64206f70657261746f727303270200000000050d0566036e072f020000002d0743036801000000225553746f72653a206661696c656420746f20756e7061636b206f70657261746f72730327020000000003480339072c02000000000200000026074307650368036c0707010000001353656e64657249734e6f744f70657261746f72030b03270321051f0200000232051f02000000020321034c051f02000000020321034c03160743036801000000066c65646765720342030c0329072f020000000c053e076503620760036e03620200000044050d076503620760036e0362072f020000002a07430368010000001f5553746f72653a206661696c656420746f20756e7061636b206c6564676572032702000000000346072f02000000350321031703300325072c020000000c053e076503620760036e0362020000001503210317051f02000000060723036e0362034203460200000036051f02000000020321034c0317051f0200000004032103160312051f020000000d0321051f020000000203170316034c032003420346034c0321051f020000003203160743036801000000066c65646765720342030c051f0200000014072f0200000004053e03690200000004030c0346035003170330051f02000000900321074303690a0000001105010000000b746f74616c537570706c790329072f020000002707430368010000001c5553746f72653a206e6f206669656c6420746f74616c537570706c7903270200000000050d0362072f020000002f0743036801000000245553746f72653a206661696c656420746f20756e7061636b20746f74616c537570706c790327020000000003120356072f020000002a07430368010000001f496e7465726e616c3a204e6567617469766520746f74616c20737570706c7903270200000000030c0346074303690a0000001105010000000b746f74616c537570706c7903500317051f02000000900321074303690a0000001105010000000b746f74616c4d696e7465640329072f020000002707430368010000001c5553746f72653a206e6f206669656c6420746f74616c4d696e74656403270200000000050d0362072f020000002f0743036801000000245553746f72653a206661696c656420746f20756e7061636b20746f74616c4d696e746564032702000000000312030c0346074303690a0000001105010000000b746f74616c4d696e7465640350053d036d034203210316051f020000000203170342',
    '0507070100000004636f6465010000000963616c6c5061757365',
    '05020000014803210316051f02000000020317050d036c072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316032003170321074303690a0000000f0501000000096f70657261746f72730329072f020000002507430368010000001a5553746f72653a206e6f206669656c64206f70657261746f727303270200000000050d0566036e072f020000002d0743036801000000225553746f72653a206661696c656420746f20756e7061636b206f70657261746f72730327020000000003480339072c02000000000200000026074307650368036c0707010000001353656e64657249734e6f744f70657261746f72030b032707430359030a030c0346074303690a0000000c0501000000067061757365640350053d036d034203210316051f020000000203170342',
    '0507070100000004636f6465010000000b63616c6c417070726f7665',
    '05020000037103210316051f02000000020317050d0765036e0362072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f0200000002031703480342051f02000000b40321074303690a0000000c0501000000067061757365640329072f02000000220743036801000000175553746f72653a206e6f206669656c642070617573656403270200000000050d0359072f020000002a07430368010000001f5553746f72653a206661696c656420746f20756e7061636b2070617573656403270200000000072c0200000027034f074303680100000018546f6b656e4f7065726174696f6e73417265506175736564034203270200000000051f02000000020321034c051f02000000020321034c0321051f020000008703160743036801000000066c65646765720342030c0329072f020000000c053e076503620760036e03620200000044050d076503620760036e0362072f020000002a07430368010000001f5553746f72653a206661696c656420746f20756e7061636b206c6564676572032702000000000346072f02000000060723036e036202000000020317031703160329072f02000000060743036200000200000000032103300325072c020000000203200200000043051f02000000020321034c0317031703300325072c020000000203200200000022074303680100000015556e73616665416c6c6f77616e63654368616e676503420327051f02000000020321034c051f020000000403210316034c0743036801000000066c65646765720342030c0329072f020000000c053e076503620760036e03620200000044050d076503620760036e0362072f020000002a07430368010000001f5553746f72653a206661696c656420746f20756e7061636b206c6564676572032702000000000346072f02000000140723036e036207430362000003420723036e0362020000000403210317071f0002020000000203210570000203170317032103300325072c02000000060320053e036202000000020346071f00030200000002032105700003031703160350051f020000000d0321051f020000000203160317034c0320034c0342034c03160743036801000000066c65646765720342030c051f0200000004030c03460350053d036d034203210316051f020000000203170342',
    '0507070100000004636f6465010000000b63616c6c556e7061757365',
    '05020000013503210316051f02000000020317050d036c072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316032003170321074303690a0000000b0501000000056f776e65720329072f02000000210743036801000000165553746f72653a206e6f206669656c64206f776e657203270200000000050d036e072f020000002907430368010000001e5553746f72653a206661696c656420746f20756e7061636b206f776e657203270200000000034803190325072c0200000000020000001f034f07430368010000001053656e64657249734e6f744f776e657203420327074303590303030c0346074303690a0000000c0501000000067061757365640350053d036d034203210316051f020000000203170342',
    '0507070100000004636f6465010000000c63616c6c4765744f776e6572',
    '05020000016703210316051f02000000020317050d0765036c036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f0200000002031703210316051f02000000020317051f02000000350555036e072f0200000025034f074303680100000016556e6578706563746564436f6e747261637454797065034203270200000000034203210316051f02000000020317051f020000000b051f02000000020321034c03420317074303690a0000000b0501000000056f776e65720329072f02000000210743036801000000165553746f72653a206e6f206669656c64206f776e657203270200000000050d036e072f020000002907430368010000001e5553746f72653a206661696c656420746f20756e7061636b206f776e657203270200000000051f02000000020313034d053d036d034c031b034203210316051f020000000203170342',
    '0507070100000004636f6465010000000c63616c6c5472616e73666572',
    '0502000008d203210316051f02000000020317050d0765036e0765036e0362072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f02000000020317051f02000000b40321074303690a0000000c0501000000067061757365640329072f02000000220743036801000000175553746f72653a206e6f206669656c642070617573656403270200000000050d0359072f020000002a07430368010000001f5553746f72653a206661696c656420746f20756e7061636b2070617573656403270200000000072c0200000027034f074303680100000018546f6b656e4f7065726174696f6e734172655061757365640342032702000000000321032103170316051f0200000002031603190325072c02000000020320020000078203210316034803190325072c020000000002000002790321051f02000002700321051f02000000b5051f020000000203210316034803420321051f020000008703170743036801000000066c65646765720342030c0329072f020000000c053e076503620760036e03620200000044050d076503620760036e0362072f020000002a07430368010000001f5553746f72653a206661696c656420746f20756e7061636b206c6564676572032702000000000346072f02000000060723036e03620200000002031703160329072f0200000006074303620000020000000003210316051f020000006b0348051f0200000060032103170317071f00020200000002032105700002034b0356072f020000003b051f02000000020321034c051f02000000020321034c0317031703420743036801000000124e6f74456e6f756768416c6c6f77616e636503420327020000000003420342051f020000000403200320051f02000000020321034c051f020000000403210316034c0743036801000000066c65646765720342030c0329072f020000000c053e076503620760036e03620200000044050d076503620760036e0362072f020000002a07430368010000001f5553746f72653a206661696c656420746f20756e7061636b206c6564676572032702000000000346072f02000000140723036e036207430362000003420723036e0362020000000403210317071f0002020000000203210570000203170317032103300325072c02000000060320053e036202000000020346071f00030200000002032105700003031703160350051f020000000d0321051f020000000203160317034c0320034c0342034c03160743036801000000066c65646765720342030c051f0200000004030c03460350051f02000000020321034c051f02000000020321034c031703160743036801000000066c65646765720342030c0329072f020000000c053e076503620760036e03620200000044050d076503620760036e0362072f020000002a07430368010000001f5553746f72653a206661696c656420746f20756e7061636b206c6564676572032702000000000346072f020000003903210317031703300325072c020000000c053e076503620760036e03620200000017032103170317051f02000000060723036e0362034203460200000038051f02000000020321034c03170317051f0200000004032103160312051f020000000d0321051f020000000203170316034c032003420346034c0321051f0200000034031703160743036801000000066c65646765720342030c051f0200000014072f0200000004053e03690200000004030c034603500321051f02000000f7031703170330051f02000000900321074303690a0000001105010000000b746f74616c537570706c790329072f020000002707430368010000001c5553746f72653a206e6f206669656c6420746f74616c537570706c7903270200000000050d0362072f020000002f0743036801000000245553746f72653a206661696c656420746f20756e7061636b20746f74616c537570706c790327020000000003120356072f020000002a07430368010000001f496e7465726e616c3a204e6567617469766520746f74616c20737570706c7903270200000000030c0346074303690a0000001105010000000b746f74616c537570706c790350051f02000000020321034c051f02000000020321034c03160743036801000000066c65646765720342030c0329072f020000000c053e076503620760036e03620200000044050d076503620760036e0362072f020000002a07430368010000001f5553746f72653a206661696c656420746f20756e7061636b206c6564676572032702000000000346072f020000002b03170317074303620000034c03420743036801000000104e6f74456e6f75676842616c616e636503420327020000000003210316071f0002020000000203210570000203170317034c034b0356072f02000000300316051f02000000020321034c0317031703420743036801000000104e6f74456e6f75676842616c616e6365034203270200000000051f020000000d0321051f020000000203170316034c03200342051f02000000020321034c051f02000000700321031603300325072c020000002603210317034503300325072c020000000e0320053e076503620760036e03620200000002034602000000020346034c03160743036801000000066c65646765720342030c051f0200000014072f0200000004053e03690200000004030c0346035003170317033b051f02000000900321074303690a0000001105010000000b746f74616c537570706c790329072f020000002707430368010000001c5553746f72653a206e6f206669656c6420746f74616c537570706c7903270200000000050d0362072f020000002f0743036801000000245553746f72653a206661696c656420746f20756e7061636b20746f74616c537570706c790327020000000003120356072f020000002a07430368010000001f496e7465726e616c3a204e6567617469766520746f74616c20737570706c7903270200000000030c0346074303690a0000001105010000000b746f74616c537570706c790350053d036d034203210316051f020000000203170342',
    '0507070100000004636f6465010000000e63616c6c47657442616c616e6365',
    '05020000017b03210316051f02000000020317050d0765036e036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f0200000002031703210316051f02000000020317051f020000003505550362072f0200000025034f074303680100000016556e6578706563746564436f6e747261637454797065034203270200000000034203210316051f02000000020317051f020000000b051f02000000020321034c034203210316051f020000000203170743036801000000066c65646765720342030c0329072f020000000c053e076503620760036e03620200000044050d076503620760036e0362072f020000002a07430368010000001f5553746f72653a206661696c656420746f20756e7061636b206c6564676572032702000000000346072f020000000607430362000002000000020316051f02000000020313034d053d036d034c031b034203210316051f020000000203170342',
    '0507070100000004636f6465010000000f63616c6c4164644f70657261746f72',
    '0502000001d903210316051f02000000020317050d036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f02000000020317051f02000000af0321074303690a0000000b0501000000056f776e65720329072f02000000210743036801000000165553746f72653a206e6f206669656c64206f776e657203270200000000050d036e072f020000002907430368010000001e5553746f72653a206661696c656420746f20756e7061636b206f776e657203270200000000034803190325072c0200000000020000001f034f07430368010000001053656e64657249734e6f744f776e657203420327051f02000000920321074303690a0000000f0501000000096f70657261746f72730329072f020000002507430368010000001a5553746f72653a206e6f206669656c64206f70657261746f727303270200000000050d0566036e072f020000002d0743036801000000225553746f72653a206661696c656420746f20756e7061636b206f70657261746f72730327020000000007430359030a0350030c0346074303690a0000000f0501000000096f70657261746f72730350053d036d034203210316051f020000000203170342',
    '0507070100000004636f6465010000001063616c6c476574416c6c6f77616e6365',
    '0502000001a003210316051f02000000020317050d07650765036e036e036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f0200000002031703210316051f02000000020317051f020000003505550362072f0200000025034f074303680100000016556e6578706563746564436f6e747261637454797065034203270200000000034203210316051f02000000020317051f020000000b051f02000000020321034c034203210316051f020000000203170321051f020000008703160743036801000000066c65646765720342030c0329072f020000000c053e076503620760036e03620200000044050d076503620760036e0362072f020000002a07430368010000001f5553746f72653a206661696c656420746f20756e7061636b206c6564676572032702000000000346072f02000000060723036e03620200000002031703170329072f02000000060743036200000200000000051f02000000020313034d053d036d034c031b034203210316051f020000000203170342',
    '0507070100000004636f6465010000001063616c6c476574546f6b656e436f6465',
    '05020000017303210316051f02000000020317050d0765036c036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f0200000002031703210316051f02000000020317051f020000003505550368072f0200000025034f074303680100000016556e6578706563746564436f6e747261637454797065034203270200000000034203210316051f02000000020317051f020000000b051f02000000020321034c03420317074303690a0000000f050100000009746f6b656e436f64650329072f020000002507430368010000001a5553746f72653a206e6f206669656c6420746f6b656e436f646503270200000000050d0368072f020000002d0743036801000000225553746f72653a206661696c656420746f20756e7061636b20746f6b656e436f646503270200000000051f02000000020313034d053d036d034c031b034203210316051f020000000203170342',
    '0507070100000004636f6465010000001063616c6c476574546f6b656e4e616d65',
    '05020000017303210316051f02000000020317050d0765036c036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f0200000002031703210316051f02000000020317051f020000003505550368072f0200000025034f074303680100000016556e6578706563746564436f6e747261637454797065034203270200000000034203210316051f02000000020317051f020000000b051f02000000020321034c03420317074303690a0000000f050100000009746f6b656e4e616d650329072f020000002507430368010000001a5553746f72653a206e6f206669656c6420746f6b656e4e616d6503270200000000050d0368072f020000002d0743036801000000225553746f72653a206661696c656420746f20756e7061636b20746f6b656e4e616d6503270200000000051f02000000020313034d053d036d034c031b034203210316051f020000000203170342',
    '0507070100000004636f6465010000001263616c6c476574546f74616c4275726e6564',
    '05020000017903210316051f02000000020317050d0765036c036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f0200000002031703210316051f02000000020317051f020000003505550362072f0200000025034f074303680100000016556e6578706563746564436f6e747261637454797065034203270200000000034203210316051f02000000020317051f020000000b051f02000000020321034c03420317074303690a0000001105010000000b746f74616c4275726e65640329072f020000002707430368010000001c5553746f72653a206e6f206669656c6420746f74616c4275726e656403270200000000050d0362072f020000002f0743036801000000245553746f72653a206661696c656420746f20756e7061636b20746f74616c4275726e656403270200000000051f02000000020313034d053d036d034c031b034203210316051f020000000203170342',
    '0507070100000004636f6465010000001263616c6c476574546f74616c4d696e746564',
    '05020000017903210316051f02000000020317050d0765036c036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f0200000002031703210316051f02000000020317051f020000003505550362072f0200000025034f074303680100000016556e6578706563746564436f6e747261637454797065034203270200000000034203210316051f02000000020317051f020000000b051f02000000020321034c03420317074303690a0000001105010000000b746f74616c4d696e7465640329072f020000002707430368010000001c5553746f72653a206e6f206669656c6420746f74616c4d696e74656403270200000000050d0362072f020000002f0743036801000000245553746f72653a206661696c656420746f20756e7061636b20746f74616c4d696e74656403270200000000051f02000000020313034d053d036d034c031b034203210316051f020000000203170342',
    '0507070100000004636f6465010000001263616c6c476574546f74616c537570706c79',
    '05020000017903210316051f02000000020317050d0765036c036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f0200000002031703210316051f02000000020317051f020000003505550362072f0200000025034f074303680100000016556e6578706563746564436f6e747261637454797065034203270200000000034203210316051f02000000020317051f020000000b051f02000000020321034c03420317074303690a0000001105010000000b746f74616c537570706c790329072f020000002707430368010000001c5553746f72653a206e6f206669656c6420746f74616c537570706c7903270200000000050d0362072f020000002f0743036801000000245553746f72653a206661696c656420746f20756e7061636b20746f74616c537570706c7903270200000000051f02000000020313034d053d036d034c031b034203210316051f020000000203170342',
    '0507070100000004636f6465010000001263616c6c52656d6f76654f70657261746f72',
    '0502000001d903210316051f02000000020317050d036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f02000000020317051f02000000af0321074303690a0000000b0501000000056f776e65720329072f02000000210743036801000000165553746f72653a206e6f206669656c64206f776e657203270200000000050d036e072f020000002907430368010000001e5553746f72653a206661696c656420746f20756e7061636b206f776e657203270200000000034803190325072c0200000000020000001f034f07430368010000001053656e64657249734e6f744f776e657203420327051f02000000920321074303690a0000000f0501000000096f70657261746f72730329072f020000002507430368010000001a5553746f72653a206e6f206669656c64206f70657261746f727303270200000000050d0566036e072f020000002d0743036801000000225553746f72653a206661696c656420746f20756e7061636b206f70657261746f7273032702000000000743035903030350030c0346074303690a0000000f0501000000096f70657261746f72730350053d036d034203210316051f020000000203170342',
    '0507070100000004636f6465010000001363616c6c4163636570744f776e657273686970',
    '05020000025003210316051f02000000020317050d036c072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316032003170321074303690a0000000e0501000000086e65774f776e65720329072f02000000240743036801000000195553746f72653a206e6f206669656c64206e65774f776e657203270200000000050d0563036e072f020000002c0743036801000000215553746f72653a206661696c656420746f20756e7061636b206e65774f776e657203270200000000072f0200000029034f07430368010000001a4e6f74496e5472616e736665724f776e6572736869704d6f6465034203270200000034034803190325072c02000000000200000022034f07430368010000001353656e64657249734e6f744e65774f776e6572034203270321074303690a0000000e0501000000086e65774f776e65720329072f02000000240743036801000000195553746f72653a206e6f206669656c64206e65774f776e657203270200000000050d0563036e072f020000002c0743036801000000215553746f72653a206661696c656420746f20756e7061636b206e65774f776e657203270200000000072f0200000029034f07430368010000001a4e6f74496e5472616e736665724f776e6572736869704d6f646503420327020000003b030c0346074303690a0000000b0501000000056f776e65720350053e036e030c0346074303690a0000000e0501000000086e65774f776e65720350053d036d034203210316051f020000000203170342',
    '0507070100000004636f6465010000001463616c6c47657452656465656d41646472657373',
    '05020000017f03210316051f02000000020317050d0765036c036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f0200000002031703210316051f02000000020317051f02000000350555036e072f0200000025034f074303680100000016556e6578706563746564436f6e747261637454797065034203270200000000034203210316051f02000000020317051f020000000b051f02000000020321034c03420317074303690a0000001305010000000d72656465656d416464726573730329072f020000002907430368010000001e5553746f72653a206e6f206669656c642072656465656d4164647265737303270200000000050d036e072f02000000310743036801000000265553746f72653a206661696c656420746f20756e7061636b2072656465656d4164647265737303270200000000051f02000000020313034d053d036d034c031b034203210316051f020000000203170342',
    '0507070100000004636f6465010000001463616c6c53657452656465656d41646472657373',
    '05020000014203210316051f02000000020317050d036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f02000000020317051f02000000af0321074303690a0000000b0501000000056f776e65720329072f02000000210743036801000000165553746f72653a206e6f206669656c64206f776e657203270200000000050d036e072f020000002907430368010000001e5553746f72653a206661696c656420746f20756e7061636b206f776e657203270200000000034803190325072c0200000000020000001f034f07430368010000001053656e64657249734e6f744f776e657203420327030c0346074303690a0000001305010000000d72656465656d416464726573730350053d036d034203210316051f020000000203170342',
    '0507070100000004636f6465010000001563616c6c5472616e736665724f776e657273686970',
    '05020000013f03210316051f02000000020317050d036e072f0200000029034f07430368010000001a55706172616d417267756d656e74556e7061636b4661696c6564034203270200000000034203210316051f02000000020317051f02000000af0321074303690a0000000b0501000000056f776e65720329072f02000000210743036801000000165553746f72653a206e6f206669656c64206f776e657203270200000000050d036e072f020000002907430368010000001e5553746f72653a206661696c656420746f20756e7061636b206f776e657203270200000000034803190325072c0200000000020000001f034f07430368010000001053656e64657249734e6f744f776e6572034203270346030c0346074303690a0000000e0501000000086e65774f776e65720350053d036d034203210316051f020000000203170342',
]


class TestPacking(TestCase):
    @parameterized.expand(
        [
            (
                {"bytes": "000018896fcfc6690baefa9aedc6d759f9bf05727e8c"},
                {"prim": "address"},
                "expru2YV8AanTTUSV4K21P7X4DzbuWQFVk7NewDuP1A5uamffiiFA3",
            ),
            (
                {"string": "tz1MsmYzmqxHs9trE1qQugZxxcLPqAXdQaX9"},
                {"prim": "address"},
                "expru2YV8AanTTUSV4K21P7X4DzbuWQFVk7NewDuP1A5uamffiiFA3",
            ),
            ({"string": "Game one!"}, {"prim": "string"}, "exprtiRSZkLKYRess9GZ3ryb4cVQD36WLo2oysZBFxKTZ2jXqcHWGj"),
            ({"int": "505506"}, {"prim": "int"}, "exprufzwVGdAX7zG91UpiAkR2yVxEDE75tHD5YgSBmYMUx22teZTCM"),
            (
                [{"int": "1"}, {"int": "1"}, {"int": "1"}, {"int": "1"}],
                {"prim": "pair", "args": [{"prim": "int"}, {"prim": "int"}, {"prim": "int"}, {"prim": "int"}]},
                "expruN32WETsB2Dx1AynDmMufVr1As9qdnjRxKQ82rk2qZ4uxuKVMK",
            ),
        ]
    )
    def test_get_key_hash(self, val_expr, type_expr, expected):
        ty = MichelsonType.match(type_expr)
        key = ty.from_micheline_value(val_expr).pack(legacy=True)
        self.assertEqual(expected, forge_script_expr(key))

    @parameterized.expand([(x,) for x in unknown_data])
    def test_blind_unpack(self, data):
        data = bytes.fromhex(data)
        res = blind_unpack(data)
        self.assertNotEqual(data, res)

    def test_regr_local_remote_diff(self):
        opg = {
            'branch': 'BKpLvH3E3bUa5Z2nb3RkH2p6EKLfymvxUAEgtRJnu4m9UX1TWUb',
            'contents': [
                {
                    'amount': '0',
                    'counter': '446245',
                    'destination': 'KT1VYUxhLoSvouozCaDGL1XcswnagNfwr3yi',
                    'fee': '104274',
                    'gas_limit': '1040000',
                    'kind': 'transaction',
                    'parameters': {'entrypoint': 'default', 'value': {'prim': 'Unit'}},
                    'source': 'tz1grSQDByRpnVs7sPtaprNZRp531ZKz6Jmm',
                    'storage_limit': '60000',
                }
            ],
            'protocol': 'PsCARTHAGazKbHtnKfLzQg3kms52kSRpgnDY982a9oYsSXRLQEb',
            'signature': None,
        }
        local = forge_operation_group(opg).hex()
        remote = (
            "0dc397b7865779d87bd47d406e8b4eee84498f22ab01dff124433c7f057af5ae6c00e8b36c80efb51ec85a1456"
            "2426049aa182a3ce38d2ae06a59e1b80bd3fe0d4030001e5ebf2dcc7dcc9d13c2c45cd76823dd604740c7f0000"
        )

        self.assertEqual(remote, local)

    def test_forge_combs(self):
        expr = {'prim': 'Pair', 'args': [{'int': '1'}, {'int': '2'}, {'int': '3'}, {'int': '4'}]}
        self.assertEqual(expr, unforge_micheline(forge_micheline(expr)))

    def test_prim_sequence_three_args(self):
        packed = "0502000000f003200743036e0a00000016010cd84cb6f78f1e146e5e86b3648327edfd45618e0007430368010000000c63616c6c6261636b2d343034037706550765096500000031046e0000000625766f746572045d0000000a2563616e64696461746504590000000f25657865637574655f766f74696e670000000c25766f74655f706172616d73046e00000007256275636b657400000010256c61756e63685f63616c6c6261636b072f020000000203270200000004034c03200743036a00000521000307430359030a0743035d0a00000015002523250b271e153be6c2668954114be101d04d3d05700005054200030342034d"

        data = bytes.fromhex(packed)
        result = unforge_micheline(data[1:])

        expected_result = [
            {'prim': 'DROP'},
            {'prim': 'PUSH', 'args': [{'prim': 'address'}, {'bytes': '010cd84cb6f78f1e146e5e86b3648327edfd45618e00'}]},
            {'prim': 'PUSH', 'args': [{'prim': 'string'}, {'string': 'callback-404'}]},
            {'prim': 'SELF_ADDRESS'},
            {
                'prim': 'CONTRACT',
                'args': [
                    {
                        'prim': 'pair',
                        'args': [
                            {
                                'prim': 'pair',
                                'args': [
                                    {'prim': 'address', 'annots': ['%voter']},
                                    {'prim': 'key_hash', 'annots': ['%candidate']},
                                    {'prim': 'bool', 'annots': ['%execute_voting']},
                                ],
                                'annots': ['%vote_params'],
                            },
                            {'prim': 'address', 'annots': ['%bucket']},
                        ],
                    }
                ],
                'annots': ['%launch_callback'],
            },
            {'prim': 'IF_NONE', 'args': [[{'prim': 'FAILWITH'}], [{'prim': 'SWAP'}, {'prim': 'DROP'}]]},
            {'prim': 'PUSH', 'args': [{'prim': 'mutez'}, {'int': '0'}]},
            {'prim': 'DUP', 'args': [{'int': '3'}]},
            {'prim': 'PUSH', 'args': [{'prim': 'bool'}, {'prim': 'True'}]},
            {'prim': 'PUSH', 'args': [{'prim': 'key_hash'}, {'bytes': '002523250b271e153be6c2668954114be101d04d3d'}]},
            {'prim': 'DIG', 'args': [{'int': '5'}]},
            {'prim': 'PAIR', 'args': [{'int': '3'}]},
            {'prim': 'PAIR'},
            {'prim': 'TRANSFER_TOKENS'},
        ]

        self.assertListEqual(result, expected_result)

        self.assertListEqual(expected_result, unforge_micheline(forge_micheline(expected_result)))
